const Runtime = require('../../engine/runtime');

const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const Clone = require('../../util/clone');
const Cast = require('../../util/cast');
const formatMessage = require('format-message');
const Video = require('../../io/video');

const VideoMotion = require('./library');

/**
 * Icon svg to be displayed in the blocks category menu, encoded as a data URI.
 * @type {string}
 */
// eslint-disable-next-line max-len
const menuIconURI = 'data:image/png;base64,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';

/**
 * Icon svg to be displayed at the left edge of each extension block, encoded as a data URI.
 * @type {string}
 */
// eslint-disable-next-line max-len
const blockIconURI = 'data:image/png;base64,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';

/**
 * Sensor attribute video sensor block should report.
 * @readonly
 * @enum {string}
 */
const SensingAttribute = {
    /** The amount of motion. */
    MOTION: 'motion',

    /** The direction of the motion. */
    DIRECTION: 'direction'
};

/**
 * Subject video sensor block should report for.
 * @readonly
 * @enum {string}
 */
const SensingSubject = {
    /** The sensor traits of the whole stage. */
    STAGE: 'Stage',

    /** The senosr traits of the area overlapped by this sprite. */
    SPRITE: 'this sprite'
};

/**
 * States the video sensing activity can be set to.
 * @readonly
 * @enum {string}
 */
const VideoState = {
    /** Video turned off. */
    OFF: 'off',

    /** Video turned on with default y axis mirroring. */
    ON: 'on',

    /** Video turned on without default y axis mirroring. */
    ON_FLIPPED: 'on-flipped'
};

/**
 * Class for the motion-related blocks in Scratch 3.0
 * @param {Runtime} runtime - the runtime instantiating this block package.
 * @constructor
 */
class Scratch3VideoSensingBlocks {
    constructor (runtime) {
        /**
         * The runtime instantiating this block package.
         * @type {Runtime}
         */
        this.runtime = runtime;

        /**
         * The motion detection algoritm used to power the motion amount and
         * direction values.
         * @type {VideoMotion}
         */
        this.detect = new VideoMotion();

        /**
         * The last millisecond epoch timestamp that the video stream was
         * analyzed.
         * @type {number}
         */
        this._lastUpdate = null;

        /**
         * A flag to determine if this extension has been installed in a project.
         * It is set to false the first time getInfo is run.
         * @type {boolean}
         */
        this.firstInstall = true;

        if (this.runtime.ioDevices) {
            // Configure the video device with values from globally stored locations.
            this.runtime.on(Runtime.PROJECT_LOADED, this.updateVideoDisplay.bind(this));

            // Clear target motion state values when the project starts.
            this.runtime.on(Runtime.PROJECT_RUN_START, this.reset.bind(this));

            // Kick off looping the analysis logic.
            this._loop();
        }
    }

    /**
     * After analyzing a frame the amount of milliseconds until another frame
     * is analyzed.
     * @type {number}
     */
    static get INTERVAL () {
        return 33;
    }

    /**
     * Dimensions the video stream is analyzed at after its rendered to the
     * sample canvas.
     * @type {Array.<number>}
     */
    static get DIMENSIONS () {
        return [480, 360];
    }

    /**
     * The key to load & store a target's motion-related state.
     * @type {string}
     */
    static get STATE_KEY () {
        return 'Scratch.videoSensing';
    }

    /**
     * The default motion-related state, to be used when a target has no existing motion state.
     * @type {MotionState}
     */
    static get DEFAULT_MOTION_STATE () {
        return {
            motionFrameNumber: 0,
            motionAmount: 0,
            motionDirection: 0
        };
    }

    /**
     * The transparency setting of the video preview stored in a value
     * accessible by any object connected to the virtual machine.
     * @type {number}
     */
    get globalVideoTransparency () {
        const stage = this.runtime.getTargetForStage();
        if (stage) {
            return stage.videoTransparency;
        }
        return 50;
    }

    set globalVideoTransparency (transparency) {
        const stage = this.runtime.getTargetForStage();
        if (stage) {
            stage.videoTransparency = transparency;
        }
        return transparency;
    }

    /**
     * The video state of the video preview stored in a value accessible by any
     * object connected to the virtual machine.
     * @type {number}
     */
    get globalVideoState () {
        const stage = this.runtime.getTargetForStage();
        if (stage) {
            return stage.videoState;
        }
        // Though the default value for the stage is normally 'on', we need to default
        // to 'off' here to prevent the video device from briefly activating
        // while waiting for stage targets to be installed that say it should be off
        return VideoState.OFF;
    }

    set globalVideoState (state) {
        const stage = this.runtime.getTargetForStage();
        if (stage) {
            stage.videoState = state;
        }
        return state;
    }

    /**
     * Get the latest values for video transparency and state,
     * and set the video device to use them.
     */
    updateVideoDisplay () {
        this.setVideoTransparency({
            TRANSPARENCY: this.globalVideoTransparency
        });
        this.videoToggle({
            VIDEO_STATE: this.globalVideoState
        });
    }

    /**
     * Reset the extension's data motion detection data. This will clear out
     * for example old frames, so the first analyzed frame will not be compared
     * against a frame from before reset was called.
     */
    reset () {
        this.detect.reset();

        const targets = this.runtime.targets;
        for (let i = 0; i < targets.length; i++) {
            const state = targets[i].getCustomState(Scratch3VideoSensingBlocks.STATE_KEY);
            if (state) {
                state.motionAmount = 0;
                state.motionDirection = 0;
            }
        }
    }

    /**
     * Occasionally step a loop to sample the video, stamp it to the preview
     * skin, and add a TypedArray copy of the canvas's pixel data.
     * @private
     */
    _loop () {
        setTimeout(this._loop.bind(this), Math.max(this.runtime.currentStepTime, Scratch3VideoSensingBlocks.INTERVAL));

        // Add frame to detector
        const time = Date.now();
        if (this._lastUpdate === null) {
            this._lastUpdate = time;
        }
        const offset = time - this._lastUpdate;
        if (offset > Scratch3VideoSensingBlocks.INTERVAL) {
            const frame = this.runtime.ioDevices.video.getFrame({
                format: Video.FORMAT_IMAGE_DATA,
                dimensions: Scratch3VideoSensingBlocks.DIMENSIONS
            });
            if (frame) {
                this._lastUpdate = time;
                this.detect.addFrame(frame.data);
            }
        }
    }

    /**
     * Create data for a menu in scratch-blocks format, consisting of an array
     * of objects with text and value properties. The text is a translated
     * string, and the value is one-indexed.
     * @param {object[]} info - An array of info objects each having a name
     *   property.
     * @return {array} - An array of objects with text and value properties.
     * @private
     */
    _buildMenu (info) {
        return info.map((entry, index) => {
            const obj = {};
            obj.text = entry.name;
            obj.value = entry.value || String(index + 1);
            return obj;
        });
    }

    /**
     * @param {Target} target - collect motion state for this target.
     * @returns {MotionState} the mutable motion state associated with that
     *   target. This will be created if necessary.
     * @private
     */
    _getMotionState (target) {
        let motionState = target.getCustomState(Scratch3VideoSensingBlocks.STATE_KEY);
        if (!motionState) {
            motionState = Clone.simple(Scratch3VideoSensingBlocks.DEFAULT_MOTION_STATE);
            target.setCustomState(Scratch3VideoSensingBlocks.STATE_KEY, motionState);
        }
        return motionState;
    }

    static get SensingAttribute () {
        return SensingAttribute;
    }

    /**
     * An array of choices of whether a reporter should return the frame's
     * motion amount or direction.
     * @type {object[]}
     * @param {string} name - the translatable name to display in sensor
     *   attribute menu
     * @param {string} value - the serializable value of the attribute
     */
    get ATTRIBUTE_INFO () {
        return [
            {
                name: formatMessage({
                    id: 'videoSensing.motion',
                    default: 'motion',
                    description: 'Attribute for the "video [ATTRIBUTE] on [SUBJECT]" block'
                }),
                value: SensingAttribute.MOTION
            },
            {
                name: formatMessage({
                    id: 'videoSensing.direction',
                    default: 'direction',
                    description: 'Attribute for the "video [ATTRIBUTE] on [SUBJECT]" block'
                }),
                value: SensingAttribute.DIRECTION
            }
        ];
    }

    static get SensingSubject () {
        return SensingSubject;
    }

    /**
     * An array of info about the subject choices.
     * @type {object[]}
     * @param {string} name - the translatable name to display in the subject menu
     * @param {string} value - the serializable value of the subject
     */
    get SUBJECT_INFO () {
        return [
            {
                name: formatMessage({
                    id: 'videoSensing.sprite',
                    default: 'sprite',
                    description: 'Subject for the "video [ATTRIBUTE] on [SUBJECT]" block'
                }),
                value: SensingSubject.SPRITE
            },
            {
                name: formatMessage({
                    id: 'videoSensing.stage',
                    default: 'stage',
                    description: 'Subject for the "video [ATTRIBUTE] on [SUBJECT]" block'
                }),
                value: SensingSubject.STAGE
            }
        ];
    }

    /**
     * States the video sensing activity can be set to.
     * @readonly
     * @enum {string}
     */
    static get VideoState () {
        return VideoState;
    }

    /**
     * An array of info on video state options for the "turn video [STATE]" block.
     * @type {object[]}
     * @param {string} name - the translatable name to display in the video state menu
     * @param {string} value - the serializable value stored in the block
     */
    get VIDEO_STATE_INFO () {
        return [
            {
                name: formatMessage({
                    id: 'videoSensing.off',
                    default: 'off',
                    description: 'Option for the "turn video [STATE]" block'
                }),
                value: VideoState.OFF
            },
            {
                name: formatMessage({
                    id: 'videoSensing.on',
                    default: 'on',
                    description: 'Option for the "turn video [STATE]" block'
                }),
                value: VideoState.ON
            },
            {
                name: formatMessage({
                    id: 'videoSensing.onFlipped',
                    default: 'on flipped',
                    description: 'Option for the "turn video [STATE]" block that causes the video to be flipped' +
                        ' horizontally (reversed as in a mirror)'
                }),
                value: VideoState.ON_FLIPPED
            }
        ];
    }

    /**
     * @returns {object} metadata for this extension and its blocks.
     */
    getInfo () {
        // Set the video display properties to defaults the first time
        // getInfo is run. This turns on the video device when it is
        // first added to a project, and is overwritten by a PROJECT_LOADED
        // event listener that later calls updateVideoDisplay
        if (this.firstInstall) {
            this.globalVideoState = VideoState.ON;
            this.globalVideoTransparency = 50;
            this.updateVideoDisplay();
            this.firstInstall = false;
        }

        // Return extension definition
        return {
            id: 'videoSensing',
            name: formatMessage({
                id: 'videoSensing.categoryName',
                default: 'Video Sensing',
                description: 'Label for the video sensing extension category'
            }),
            blockIconURI: blockIconURI,
            menuIconURI: menuIconURI,
            blocks: [
                {
                    // @todo this hat needs to be set itself to restart existing
                    // threads like Scratch 2's behaviour.
                    opcode: 'whenMotionGreaterThan',
                    text: formatMessage({
                        id: 'videoSensing.whenMotionGreaterThan',
                        default: 'when video motion > [REFERENCE]',
                        description: 'Event that triggers when the amount of motion is greater than [REFERENCE]'
                    }),
                    blockType: BlockType.HAT,
                    arguments: {
                        REFERENCE: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 10
                        }
                    }
                },
                {
                    opcode: 'videoOn',
                    blockType: BlockType.REPORTER,
                    text: formatMessage({
                        id: 'videoSensing.videoOn',
                        default: 'video [ATTRIBUTE] on [SUBJECT]',
                        description: 'Reporter that returns the amount of [ATTRIBUTE] for the selected [SUBJECT]'
                    }),
                    arguments: {
                        ATTRIBUTE: {
                            type: ArgumentType.NUMBER,
                            menu: 'ATTRIBUTE',
                            defaultValue: SensingAttribute.MOTION
                        },
                        SUBJECT: {
                            type: ArgumentType.NUMBER,
                            menu: 'SUBJECT',
                            defaultValue: SensingSubject.SPRITE
                        }
                    }
                },
                {
                    opcode: 'videoToggle',
                    text: formatMessage({
                        id: 'videoSensing.videoToggle',
                        default: 'turn video [VIDEO_STATE]',
                        description: 'Controls display of the video preview layer'
                    }),
                    arguments: {
                        VIDEO_STATE: {
                            type: ArgumentType.NUMBER,
                            menu: 'VIDEO_STATE',
                            defaultValue: VideoState.ON
                        }
                    }
                },
                {
                    opcode: 'setVideoTransparency',
                    text: formatMessage({
                        id: 'videoSensing.setVideoTransparency',
                        default: 'set video transparency to [TRANSPARENCY]',
                        description: 'Controls transparency of the video preview layer'
                    }),
                    arguments: {
                        TRANSPARENCY: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 50
                        }
                    }
                }
            ],
            menus: {
                ATTRIBUTE: {
                    acceptReporters: true,
                    items: this._buildMenu(this.ATTRIBUTE_INFO)
                },
                SUBJECT: {
                    acceptReporters: true,
                    items: this._buildMenu(this.SUBJECT_INFO)
                },
                VIDEO_STATE: {
                    acceptReporters: true,
                    items: this._buildMenu(this.VIDEO_STATE_INFO)
                }
            }
        };
    }

    /**
     * Analyze a part of the frame that a target overlaps.
     * @param {Target} target - a target to determine where to analyze
     * @returns {MotionState} the motion state for the given target
     */
    _analyzeLocalMotion (target) {
        const drawable = this.runtime.renderer._allDrawables[target.drawableID];
        const state = this._getMotionState(target);
        this.detect.getLocalMotion(drawable, state);
        return state;
    }

    /**
     * A scratch reporter block handle that analyzes the last two frames and
     * depending on the arguments, returns the motion or direction for the
     * whole stage or just the target sprite.
     * @param {object} args - the block arguments
     * @param {BlockUtility} util - the block utility
     * @returns {number} the motion amount or direction of the stage or sprite
     */
    videoOn (args, util) {
        this.detect.analyzeFrame();

        let state = this.detect;
        if (args.SUBJECT === SensingSubject.SPRITE) {
            state = this._analyzeLocalMotion(util.target);
        }

        if (args.ATTRIBUTE === SensingAttribute.MOTION) {
            return state.motionAmount;
        }
        return state.motionDirection;
    }

    /**
     * A scratch hat block edge handle that analyzes the last two frames where
     * the target sprite overlaps and if it has more motion than the given
     * reference value.
     * @param {object} args - the block arguments
     * @param {BlockUtility} util - the block utility
     * @returns {boolean} true if the sprite overlaps more motion than the
     *   reference
     */
    whenMotionGreaterThan (args, util) {
        this.detect.analyzeFrame();
        const state = this._analyzeLocalMotion(util.target);
        return state.motionAmount > Number(args.REFERENCE);
    }

    /**
     * A scratch command block handle that configures the video state from
     * passed arguments.
     * @param {object} args - the block arguments
     * @param {VideoState} args.VIDEO_STATE - the video state to set the device to
     */
    videoToggle (args) {
        const state = args.VIDEO_STATE;
        this.globalVideoState = state;
        if (state === VideoState.OFF) {
            this.runtime.ioDevices.video.disableVideo();
        } else {
            this.runtime.ioDevices.video.enableVideo();
            // Mirror if state is ON. Do not mirror if state is ON_FLIPPED.
            this.runtime.ioDevices.video.mirror = state === VideoState.ON;
        }
    }

    /**
     * A scratch command block handle that configures the video preview's
     * transparency from passed arguments.
     * @param {object} args - the block arguments
     * @param {number} args.TRANSPARENCY - the transparency to set the video
     *   preview to
     */
    setVideoTransparency (args) {
        const transparency = Cast.toNumber(args.TRANSPARENCY);
        this.globalVideoTransparency = transparency;
        this.runtime.ioDevices.video.setPreviewGhost(transparency);
    }
}

module.exports = Scratch3VideoSensingBlocks;
