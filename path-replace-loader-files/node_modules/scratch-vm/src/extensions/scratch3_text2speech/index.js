const formatMessage = require('format-message');
const languageNames = require('scratch-translate-extension-languages');

const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const Cast = require('../../util/cast');
const MathUtil = require('../../util/math-util');
const Clone = require('../../util/clone');
const log = require('../../util/log');
const fetchWithTimeout = require('../../util/fetch-with-timeout');

/**
 * Icon svg to be displayed in the blocks category menu, encoded as a data URI.
 * @type {string}
 */
// eslint-disable-next-line max-len
const menuIconURI = 'data:image/png;base64,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';
/**
 * Icon svg to be displayed at the left edge of each extension block, encoded as a data URI.
 * @type {string}
 */
// eslint-disable-next-line max-len
const blockIconURI = 'data:image/png;base64,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';

/**
 * The url of the synthesis server.
 * @type {string}
 */
const SERVER_HOST = 'https://synthesis-service.scratch.mit.edu';

/**
 * How long to wait in ms before timing out requests to synthesis server.
 * @type {int}
 */
const SERVER_TIMEOUT = 10000; // 10 seconds

/**
 * Volume for playback of speech sounds, as a percentage.
 * @type {number}
 */
const SPEECH_VOLUME = 250;

/**
 * An id for one of the voices.
 */
const ALTO_ID = 'ALTO';

/**
 * An id for one of the voices.
 */
const TENOR_ID = 'TENOR';

/**
 * An id for one of the voices.
 */
const SQUEAK_ID = 'SQUEAK';

/**
 * An id for one of the voices.
 */
const GIANT_ID = 'GIANT';

/**
 * An id for one of the voices.
 */
const KITTEN_ID = 'KITTEN';

/**
 * Playback rate for the tenor voice, for cases where we have only a female gender voice.
 */
const FEMALE_TENOR_RATE = 0.89; // -2 semitones

/**
 * Playback rate for the giant voice, for cases where we have only a female gender voice.
 */
const FEMALE_GIANT_RATE = 0.79; // -4 semitones

/**
 * Language ids. The value for each language id is a valid Scratch locale.
 */
const ARABIC_ID = 'ar';
const CHINESE_ID = 'zh-cn';
const DANISH_ID = 'da';
const DUTCH_ID = 'nl';
const ENGLISH_ID = 'en';
const FRENCH_ID = 'fr';
const GERMAN_ID = 'de';
const HINDI_ID = 'hi';
const ICELANDIC_ID = 'is';
const ITALIAN_ID = 'it';
const JAPANESE_ID = 'ja';
const KOREAN_ID = 'ko';
const NORWEGIAN_ID = 'nb';
const POLISH_ID = 'pl';
const PORTUGUESE_BR_ID = 'pt-br';
const PORTUGUESE_ID = 'pt';
const ROMANIAN_ID = 'ro';
const RUSSIAN_ID = 'ru';
const SPANISH_ID = 'es';
const SPANISH_419_ID = 'es-419';
const SWEDISH_ID = 'sv';
const TURKISH_ID = 'tr';
const WELSH_ID = 'cy';

/**
 * Class for the text2speech blocks.
 * @constructor
 */
class Scratch3Text2SpeechBlocks {
    constructor (runtime) {
        /**
         * The runtime instantiating this block package.
         * @type {Runtime}
         */
        this.runtime = runtime;

        /**
         * Map of soundPlayers by sound id.
         * @type {Map<string, SoundPlayer>}
         */
        this._soundPlayers = new Map();

        this._stopAllSpeech = this._stopAllSpeech.bind(this);
        if (this.runtime) {
            this.runtime.on('PROJECT_STOP_ALL', this._stopAllSpeech);
        }

        this._onTargetCreated = this._onTargetCreated.bind(this);
        if (this.runtime) {
            runtime.on('targetWasCreated', this._onTargetCreated);
        }

        /**
         * A list of all Scratch locales that are supported by the extension.
         * @type {Array}
         */
        this._supportedLocales = this._getSupportedLocales();
    }

    /**
     * An object with info for each voice.
     */
    get VOICE_INFO () {
        return {
            [ALTO_ID]: {
                name: formatMessage({
                    id: 'text2speech.alto',
                    default: 'alto',
                    description: 'Name for a voice with ambiguous gender.'
                }),
                gender: 'female',
                playbackRate: 1
            },
            [TENOR_ID]: {
                name: formatMessage({
                    id: 'text2speech.tenor',
                    default: 'tenor',
                    description: 'Name for a voice with ambiguous gender.'
                }),
                gender: 'male',
                playbackRate: 1
            },
            [SQUEAK_ID]: {
                name: formatMessage({
                    id: 'text2speech.squeak',
                    default: 'squeak',
                    description: 'Name for a funny voice with a high pitch.'
                }),
                gender: 'female',
                playbackRate: 1.19 // +3 semitones
            },
            [GIANT_ID]: {
                name: formatMessage({
                    id: 'text2speech.giant',
                    default: 'giant',
                    description: 'Name for a funny voice with a low pitch.'
                }),
                gender: 'male',
                playbackRate: 0.84 // -3 semitones
            },
            [KITTEN_ID]: {
                name: formatMessage({
                    id: 'text2speech.kitten',
                    default: 'kitten',
                    description: 'A baby cat.'
                }),
                gender: 'female',
                playbackRate: 1.41 // +6 semitones
            }
        };
    }

    /**
     * An object with information for each language.
     *
     * A note on the different sets of locales referred to in this extension:
     *
     * SCRATCH LOCALE
     *      Set by the editor, and used to store the language state in the project.
     *      Listed in l10n: https://github.com/LLK/scratch-l10n/blob/master/src/supported-locales.js
     * SUPPORTED LOCALE
     *      A Scratch locale that has a corresponding extension locale.
     * EXTENSION LOCALE
     *      A locale corresponding to one of the available spoken languages
     *      in the extension. There can be multiple supported locales for a single
     *      extension locale. For example, for both written versions of chinese,
     *      zh-cn and zh-tw, we use a single spoken language (Mandarin). So there
     *      are two supported locales, with a single extension locale.
     * SPEECH SYNTH LOCALE
     *      A different locale code system, used by our speech synthesis service.
     *      Each extension locale has a speech synth locale.
     */
    get LANGUAGE_INFO () {
        return {
            [ARABIC_ID]: {
                name: 'Arabic',
                locales: ['ar'],
                speechSynthLocale: 'arb',
                singleGender: true
            },
            [CHINESE_ID]: {
                name: 'Chinese (Mandarin)',
                locales: ['zh-cn', 'zh-tw'],
                speechSynthLocale: 'cmn-CN',
                singleGender: true
            },
            [DANISH_ID]: {
                name: 'Danish',
                locales: ['da'],
                speechSynthLocale: 'da-DK'
            },
            [DUTCH_ID]: {
                name: 'Dutch',
                locales: ['nl'],
                speechSynthLocale: 'nl-NL'
            },
            [ENGLISH_ID]: {
                name: 'English',
                locales: ['en'],
                speechSynthLocale: 'en-US'
            },
            [FRENCH_ID]: {
                name: 'French',
                locales: ['fr'],
                speechSynthLocale: 'fr-FR'
            },
            [GERMAN_ID]: {
                name: 'German',
                locales: ['de'],
                speechSynthLocale: 'de-DE'
            },
            [HINDI_ID]: {
                name: 'Hindi',
                locales: ['hi'],
                speechSynthLocale: 'hi-IN',
                singleGender: true
            },
            [ICELANDIC_ID]: {
                name: 'Icelandic',
                locales: ['is'],
                speechSynthLocale: 'is-IS'
            },
            [ITALIAN_ID]: {
                name: 'Italian',
                locales: ['it'],
                speechSynthLocale: 'it-IT'
            },
            [JAPANESE_ID]: {
                name: 'Japanese',
                locales: ['ja', 'ja-hira'],
                speechSynthLocale: 'ja-JP'
            },
            [KOREAN_ID]: {
                name: 'Korean',
                locales: ['ko'],
                speechSynthLocale: 'ko-KR',
                singleGender: true
            },
            [NORWEGIAN_ID]: {
                name: 'Norwegian',
                locales: ['nb', 'nn'],
                speechSynthLocale: 'nb-NO',
                singleGender: true
            },
            [POLISH_ID]: {
                name: 'Polish',
                locales: ['pl'],
                speechSynthLocale: 'pl-PL'
            },
            [PORTUGUESE_BR_ID]: {
                name: 'Portuguese (Brazilian)',
                locales: ['pt-br'],
                speechSynthLocale: 'pt-BR'
            },
            [PORTUGUESE_ID]: {
                name: 'Portuguese (European)',
                locales: ['pt'],
                speechSynthLocale: 'pt-PT'
            },
            [ROMANIAN_ID]: {
                name: 'Romanian',
                locales: ['ro'],
                speechSynthLocale: 'ro-RO',
                singleGender: true
            },
            [RUSSIAN_ID]: {
                name: 'Russian',
                locales: ['ru'],
                speechSynthLocale: 'ru-RU'
            },
            [SPANISH_ID]: {
                name: 'Spanish (European)',
                locales: ['es'],
                speechSynthLocale: 'es-ES'
            },
            [SPANISH_419_ID]: {
                name: 'Spanish (Latin American)',
                locales: ['es-419'],
                speechSynthLocale: 'es-US'
            },
            [SWEDISH_ID]: {
                name: 'Swedish',
                locales: ['sv'],
                speechSynthLocale: 'sv-SE',
                singleGender: true
            },
            [TURKISH_ID]: {
                name: 'Turkish',
                locales: ['tr'],
                speechSynthLocale: 'tr-TR',
                singleGender: true
            },
            [WELSH_ID]: {
                name: 'Welsh',
                locales: ['cy'],
                speechSynthLocale: 'cy-GB',
                singleGender: true
            }
        };
    }

    /**
     * The key to load & store a target's text2speech state.
     * @return {string} The key.
     */
    static get STATE_KEY () {
        return 'Scratch.text2speech';
    }

    /**
     * The default state, to be used when a target has no existing state.
     * @type {Text2SpeechState}
     */
    static get DEFAULT_TEXT2SPEECH_STATE () {
        return {
            voiceId: ALTO_ID
        };
    }

    /**
     * A default language to use for speech synthesis.
     * @type {string}
     */
    get DEFAULT_LANGUAGE () {
        return ENGLISH_ID;
    }

    /**
     * @param {Target} target - collect  state for this target.
     * @returns {Text2SpeechState} the mutable state associated with that target. This will be created if necessary.
     * @private
     */
    _getState (target) {
        let state = target.getCustomState(Scratch3Text2SpeechBlocks.STATE_KEY);
        if (!state) {
            state = Clone.simple(Scratch3Text2SpeechBlocks.DEFAULT_TEXT2SPEECH_STATE);
            target.setCustomState(Scratch3Text2SpeechBlocks.STATE_KEY, state);
        }
        return state;
    }

    /**
     * When a Target is cloned, clone the state.
     * @param {Target} newTarget - the newly created target.
     * @param {Target} [sourceTarget] - the target used as a source for the new clone, if any.
     * @listens Runtime#event:targetWasCreated
     * @private
     */
    _onTargetCreated (newTarget, sourceTarget) {
        if (sourceTarget) {
            const state = sourceTarget.getCustomState(Scratch3Text2SpeechBlocks.STATE_KEY);
            if (state) {
                newTarget.setCustomState(Scratch3Text2SpeechBlocks.STATE_KEY, Clone.simple(state));
            }
        }
    }

    /**
     * @returns {object} metadata for this extension and its blocks.
     */
    getInfo () {
        // Only localize the default input to the "speak" block if we are in a
        // supported language.
        let defaultTextToSpeak = 'hello';
        if (this.isSupportedLanguage(this.getEditorLanguage())) {
            defaultTextToSpeak = formatMessage({
                id: 'text2speech.defaultTextToSpeak',
                default: 'hello',
                description: 'hello: the default text to speak'
            });
        }

        return {
            id: 'text2speech',
            name: formatMessage({
                id: 'text2speech.categoryName',
                default: 'Text to Speech',
                description: 'Name of the Text to Speech extension.'
            }),
            blockIconURI: blockIconURI,
            menuIconURI: menuIconURI,
            blocks: [
                {
                    opcode: 'speakAndWait',
                    text: formatMessage({
                        id: 'text2speech.speakAndWaitBlock',
                        default: 'speak [WORDS]',
                        description: 'Speak some words.'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        WORDS: {
                            type: ArgumentType.STRING,
                            defaultValue: defaultTextToSpeak
                        }
                    }
                },
                {
                    opcode: 'setVoice',
                    text: formatMessage({
                        id: 'text2speech.setVoiceBlock',
                        default: 'set voice to [VOICE]',
                        description: 'Set the voice for speech synthesis.'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        VOICE: {
                            type: ArgumentType.STRING,
                            menu: 'voices',
                            defaultValue: ALTO_ID
                        }
                    }
                },
                {
                    opcode: 'setLanguage',
                    text: formatMessage({
                        id: 'text2speech.setLanguageBlock',
                        default: 'set language to [LANGUAGE]',
                        description: 'Set the language for speech synthesis.'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        LANGUAGE: {
                            type: ArgumentType.STRING,
                            menu: 'languages',
                            defaultValue: this.getCurrentLanguage()
                        }
                    }
                }
            ],
            menus: {
                voices: {
                    acceptReporters: true,
                    items: this.getVoiceMenu()
                },
                languages: {
                    acceptReporters: true,
                    items: this.getLanguageMenu()
                }
            }
        };
    }

    /**
     * Get the language code currently set in the editor, or fall back to the
     * browser locale.
     * @return {string} a Scratch locale code.
     */
    getEditorLanguage () {
        const locale = formatMessage.setup().locale ||
            navigator.language || navigator.userLanguage || this.DEFAULT_LANGUAGE;
        return locale.toLowerCase();
    }

    /**
     * Get the language code currently set for the extension.
     * @returns {string} a Scratch locale code.
     */
    getCurrentLanguage () {
        const stage = this.runtime.getTargetForStage();
        if (!stage) return this.DEFAULT_LANGUAGE;
        // If no language has been set, set it to the editor locale (or default).
        if (!stage.textToSpeechLanguage) {
            this.setCurrentLanguage(this.getEditorLanguage());
        }
        return stage.textToSpeechLanguage;
    }

    /**
     * Set the language code for the extension.
     * It is stored in the stage so it can be saved and loaded with the project.
     * @param {string} locale a locale code.
     */
    setCurrentLanguage (locale) {
        const stage = this.runtime.getTargetForStage();
        if (!stage) return;

        if (this.isSupportedLanguage(locale)) {
            stage.textToSpeechLanguage = this._getExtensionLocaleForSupportedLocale(locale);
        }

        // Support language names dropped onto the menu via reporter block
        // such as a variable containing a language name (in any language),
        // or the translate extension's language reporter.
        const localeForDroppedName = languageNames.nameMap[locale.toLowerCase()];
        if (localeForDroppedName && this.isSupportedLanguage(localeForDroppedName)) {
            stage.textToSpeechLanguage =
                this._getExtensionLocaleForSupportedLocale(localeForDroppedName);
        }

        // If the language is null, set it to the default language.
        // This can occur e.g. if the extension was loaded with the editor
        // set to a language that is not in the list.
        if (!stage.textToSpeechLanguage) {
            stage.textToSpeechLanguage = this.DEFAULT_LANGUAGE;
        }
    }

    /**
     * Get the extension locale for a supported locale, or null.
     * @param {string} locale a locale code.
     * @returns {?string} a locale supported by the extension.
     */
    _getExtensionLocaleForSupportedLocale (locale) {
        for (const lang in this.LANGUAGE_INFO) {
            if (this.LANGUAGE_INFO[lang].locales.includes(locale)) {
                return lang;
            }
        }
        log.error(`cannot find extension locale for locale ${locale}`);
    }

    /**
     * Get the locale code used by the speech synthesis server corresponding to
     * the current language code set for the extension.
     * @returns {string} a speech synthesis locale.
     */
    _getSpeechSynthLocale () {
        let speechSynthLocale = this.LANGUAGE_INFO[this.DEFAULT_LANGUAGE].speechSynthLocale;
        if (this.LANGUAGE_INFO[this.getCurrentLanguage()]) {
            speechSynthLocale = this.LANGUAGE_INFO[this.getCurrentLanguage()].speechSynthLocale;
        }
        return speechSynthLocale;
    }

    /**
     * Get an array of the locales supported by this extension.
     * @returns {Array} An array of locale strings.
     */
    _getSupportedLocales () {
        return Object.keys(this.LANGUAGE_INFO).reduce((acc, lang) =>
            acc.concat(this.LANGUAGE_INFO[lang].locales), []);
    }

    /**
     * Check if a Scratch language code is in the list of supported languages for the
     * speech synthesis service.
     * @param {string} languageCode the language code to check.
     * @returns {boolean} true if the language code is supported.
     */
    isSupportedLanguage (languageCode) {
        return this._supportedLocales.includes(languageCode);
    }

    /**
     * Get the menu of voices for the "set voice" block.
     * @return {array} the text and value for each menu item.
     */
    getVoiceMenu () {
        return Object.keys(this.VOICE_INFO).map(voiceId => ({
            text: this.VOICE_INFO[voiceId].name,
            value: voiceId
        }));
    }

    /**
     * Get the localized menu of languages for the "set language" block.
     * For each language:
     *   if there is a custom translated spoken language name, use that;
     *   otherwise use the translation in the languageNames menuMap;
     *   otherwise fall back to the untranslated name in LANGUAGE_INFO.
     * @return {array} the text and value for each menu item.
     */
    getLanguageMenu () {
        const editorLanguage = this.getEditorLanguage();
        // Get the array of localized language names
        const localizedNameMap = {};
        let nameArray = languageNames.menuMap[editorLanguage];
        if (nameArray) {
            // Also get any localized names of spoken languages
            let spokenNameArray = [];
            if (languageNames.spokenLanguages) {
                spokenNameArray = languageNames.spokenLanguages[editorLanguage];
                nameArray = nameArray.concat(spokenNameArray);
            }
            // Create a map of language code to localized name
            // The localized spoken language names have been concatenated onto
            // the end of the name array, so the result of the forEach below is
            // when there is both a written language name (e.g. 'Chinese
            // (simplified)') and a spoken language name (e.g. 'Chinese
            // (Mandarin)', we always use the spoken version.
            nameArray.forEach(lang => {
                localizedNameMap[lang.code] = lang.name;
            });
        }

        return Object.keys(this.LANGUAGE_INFO).map(key => {
            let name = this.LANGUAGE_INFO[key].name;
            const localizedName = localizedNameMap[key];
            if (localizedName) {
                name = localizedName;
            }
            // Uppercase the first character of the name
            name = name.charAt(0).toUpperCase() + name.slice(1);
            return {
                text: name,
                value: key
            };
        });
    }

    /**
     * Set the voice for speech synthesis for this sprite.
     * @param  {object} args Block arguments
     * @param {object} util Utility object provided by the runtime.
     */
    setVoice (args, util) {
        const state = this._getState(util.target);

        let voice = args.VOICE;

        // If the arg is a dropped number, treat it as a voice index
        let voiceNum = parseInt(voice, 10);
        if (!isNaN(voiceNum)) {
            voiceNum -= 1; // Treat dropped args as one-indexed
            voiceNum = MathUtil.wrapClamp(voiceNum, 0, Object.keys(this.VOICE_INFO).length - 1);
            voice = Object.keys(this.VOICE_INFO)[voiceNum];
        }

        // Only set the voice if the arg is a valid voice id.
        if (Object.keys(this.VOICE_INFO).includes(voice)) {
            state.voiceId = voice;
        }
    }

    /**
     * Set the language for speech synthesis.
     * @param  {object} args Block arguments
     */
    setLanguage (args) {
        this.setCurrentLanguage(args.LANGUAGE);
    }

    /**
     * Stop all currently playing speech sounds.
     */
    _stopAllSpeech () {
        this._soundPlayers.forEach(player => {
            player.stop();
        });
    }

    /**
     * Convert the provided text into a sound file and then play the file.
     * @param  {object} args Block arguments
     * @param {object} util Utility object provided by the runtime.
     * @return {Promise} A promise that resolves after playing the sound
     */
    speakAndWait (args, util) {
        // Cast input to string
        let words = Cast.toString(args.WORDS);
        let locale = this._getSpeechSynthLocale();

        const state = this._getState(util.target);

        let gender = this.VOICE_INFO[state.voiceId].gender;
        let playbackRate = this.VOICE_INFO[state.voiceId].playbackRate;

        // Special case for voices where the synthesis service only provides a
        // single gender voice. In that case, always request the female voice,
        // and set special playback rates for the tenor and giant voices.
        if (this.LANGUAGE_INFO[this.getCurrentLanguage()].singleGender) {
            gender = 'female';
            if (state.voiceId === TENOR_ID) {
                playbackRate = FEMALE_TENOR_RATE;
            }
            if (state.voiceId === GIANT_ID) {
                playbackRate = FEMALE_GIANT_RATE;
            }
        }

        if (state.voiceId === KITTEN_ID) {
            words = words.replace(/\S+/g, 'meow');
            locale = this.LANGUAGE_INFO[this.DEFAULT_LANGUAGE].speechSynthLocale;
        }

        // Build up URL
        let path = `${SERVER_HOST}/synth`;
        path += `?locale=${locale}`;
        path += `&gender=${gender}`;
        path += `&text=${encodeURIComponent(words.substring(0, 128))}`;

        // Perform HTTP request to get audio file
        return fetchWithTimeout(path, {}, SERVER_TIMEOUT)
            .then(res => {
                if (res.status !== 200) {
                    throw new Error(`HTTP ${res.status} error reaching translation service`);
                }

                return res.arrayBuffer();
            })
            .then(buffer => {
                // Play the sound
                const sound = {
                    data: {
                        buffer
                    }
                };
                return this.runtime.audioEngine.decodeSoundPlayer(sound);
            })
            .then(soundPlayer => {
                this._soundPlayers.set(soundPlayer.id, soundPlayer);

                soundPlayer.setPlaybackRate(playbackRate);

                // Increase the volume
                const engine = this.runtime.audioEngine;
                const chain = engine.createEffectChain();
                chain.set('volume', SPEECH_VOLUME);
                soundPlayer.connect(chain);

                soundPlayer.play();
                return new Promise(resolve => {
                    soundPlayer.on('stop', () => {
                        this._soundPlayers.delete(soundPlayer.id);
                        resolve();
                    });
                });
            })
            .catch(err => {
                log.warn(err);
            });
    }
}
module.exports = Scratch3Text2SpeechBlocks;
