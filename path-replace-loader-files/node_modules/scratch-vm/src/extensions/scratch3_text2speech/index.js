const formatMessage = require('format-message');
const languageNames = require('scratch-translate-extension-languages');

const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const Cast = require('../../util/cast');
const MathUtil = require('../../util/math-util');
const Clone = require('../../util/clone');
const log = require('../../util/log');
const fetchWithTimeout = require('../../util/fetch-with-timeout');

/**
 * Icon svg to be displayed in the blocks category menu, encoded as a data URI.
 * @type {string}
 */
// eslint-disable-next-line max-len
const menuIconURI = 'data:image/png;base64,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';

/**
 * Icon svg to be displayed at the left edge of each extension block, encoded as a data URI.
 * @type {string}
 */
// eslint-disable-next-line max-len
const blockIconURI = 'data:image/png;base64,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'

/**
 * The url of the synthesis server.
 * @type {string}
 */
const SERVER_HOST = 'https://synthesis-service.scratch.mit.edu';

/**
 * How long to wait in ms before timing out requests to synthesis server.
 * @type {int}
 */
const SERVER_TIMEOUT = 10000; // 10 seconds

/**
 * Volume for playback of speech sounds, as a percentage.
 * @type {number}
 */
const SPEECH_VOLUME = 250;

/**
 * An id for one of the voices.
 */
const ALTO_ID = 'ALTO';

/**
 * An id for one of the voices.
 */
const TENOR_ID = 'TENOR';

/**
 * An id for one of the voices.
 */
const SQUEAK_ID = 'SQUEAK';

/**
 * An id for one of the voices.
 */
const GIANT_ID = 'GIANT';

/**
 * An id for one of the voices.
 */
const KITTEN_ID = 'KITTEN';

/**
 * Playback rate for the tenor voice, for cases where we have only a female gender voice.
 */
const FEMALE_TENOR_RATE = 0.89; // -2 semitones

/**
 * Playback rate for the giant voice, for cases where we have only a female gender voice.
 */
const FEMALE_GIANT_RATE = 0.79; // -4 semitones

/**
 * Language ids. The value for each language id is a valid Scratch locale.
 */
const ARABIC_ID = 'ar';
const CHINESE_ID = 'zh-cn';
const DANISH_ID = 'da';
const DUTCH_ID = 'nl';
const ENGLISH_ID = 'en';
const FRENCH_ID = 'fr';
const GERMAN_ID = 'de';
const HINDI_ID = 'hi';
const ICELANDIC_ID = 'is';
const ITALIAN_ID = 'it';
const JAPANESE_ID = 'ja';
const KOREAN_ID = 'ko';
const NORWEGIAN_ID = 'nb';
const POLISH_ID = 'pl';
const PORTUGUESE_BR_ID = 'pt-br';
const PORTUGUESE_ID = 'pt';
const ROMANIAN_ID = 'ro';
const RUSSIAN_ID = 'ru';
const SPANISH_ID = 'es';
const SPANISH_419_ID = 'es-419';
const SWEDISH_ID = 'sv';
const TURKISH_ID = 'tr';
const WELSH_ID = 'cy';

/**
 * Class for the text2speech blocks.
 * @constructor
 */
class Scratch3Text2SpeechBlocks {
    constructor (runtime) {
        /**
         * The runtime instantiating this block package.
         * @type {Runtime}
         */
        this.runtime = runtime;

        /**
         * Map of soundPlayers by sound id.
         * @type {Map<string, SoundPlayer>}
         */
        this._soundPlayers = new Map();

        this._stopAllSpeech = this._stopAllSpeech.bind(this);
        if (this.runtime) {
            this.runtime.on('PROJECT_STOP_ALL', this._stopAllSpeech);
        }

        this._onTargetCreated = this._onTargetCreated.bind(this);
        if (this.runtime) {
            runtime.on('targetWasCreated', this._onTargetCreated);
        }

        /**
         * A list of all Scratch locales that are supported by the extension.
         * @type {Array}
         */
        this._supportedLocales = this._getSupportedLocales();
    }

    /**
     * An object with info for each voice.
     */
    get VOICE_INFO () {
        return {
            [ALTO_ID]: {
                name: formatMessage({
                    id: 'text2speech.alto',
                    default: 'alto',
                    description: 'Name for a voice with ambiguous gender.'
                }),
                gender: 'female',
                playbackRate: 1
            },
            [TENOR_ID]: {
                name: formatMessage({
                    id: 'text2speech.tenor',
                    default: 'tenor',
                    description: 'Name for a voice with ambiguous gender.'
                }),
                gender: 'male',
                playbackRate: 1
            },
            [SQUEAK_ID]: {
                name: formatMessage({
                    id: 'text2speech.squeak',
                    default: 'squeak',
                    description: 'Name for a funny voice with a high pitch.'
                }),
                gender: 'female',
                playbackRate: 1.19 // +3 semitones
            },
            [GIANT_ID]: {
                name: formatMessage({
                    id: 'text2speech.giant',
                    default: 'giant',
                    description: 'Name for a funny voice with a low pitch.'
                }),
                gender: 'male',
                playbackRate: 0.84 // -3 semitones
            },
            [KITTEN_ID]: {
                name: formatMessage({
                    id: 'text2speech.kitten',
                    default: 'kitten',
                    description: 'A baby cat.'
                }),
                gender: 'female',
                playbackRate: 1.41 // +6 semitones
            }
        };
    }

    /**
     * An object with information for each language.
     *
     * A note on the different sets of locales referred to in this extension:
     *
     * SCRATCH LOCALE
     *      Set by the editor, and used to store the language state in the project.
     *      Listed in l10n: https://github.com/LLK/scratch-l10n/blob/master/src/supported-locales.js
     * SUPPORTED LOCALE
     *      A Scratch locale that has a corresponding extension locale.
     * EXTENSION LOCALE
     *      A locale corresponding to one of the available spoken languages
     *      in the extension. There can be multiple supported locales for a single
     *      extension locale. For example, for both written versions of chinese,
     *      zh-cn and zh-tw, we use a single spoken language (Mandarin). So there
     *      are two supported locales, with a single extension locale.
     * SPEECH SYNTH LOCALE
     *      A different locale code system, used by our speech synthesis service.
     *      Each extension locale has a speech synth locale.
     */
    get LANGUAGE_INFO () {
        return {
            [ARABIC_ID]: {
                name: 'Arabic',
                locales: ['ar'],
                speechSynthLocale: 'arb',
                singleGender: true
            },
            [CHINESE_ID]: {
                name: 'Chinese (Mandarin)',
                locales: ['zh-cn', 'zh-tw'],
                speechSynthLocale: 'cmn-CN',
                singleGender: true
            },
            [DANISH_ID]: {
                name: 'Danish',
                locales: ['da'],
                speechSynthLocale: 'da-DK'
            },
            [DUTCH_ID]: {
                name: 'Dutch',
                locales: ['nl'],
                speechSynthLocale: 'nl-NL'
            },
            [ENGLISH_ID]: {
                name: 'English',
                locales: ['en'],
                speechSynthLocale: 'en-US'
            },
            [FRENCH_ID]: {
                name: 'French',
                locales: ['fr'],
                speechSynthLocale: 'fr-FR'
            },
            [GERMAN_ID]: {
                name: 'German',
                locales: ['de'],
                speechSynthLocale: 'de-DE'
            },
            [HINDI_ID]: {
                name: 'Hindi',
                locales: ['hi'],
                speechSynthLocale: 'hi-IN',
                singleGender: true
            },
            [ICELANDIC_ID]: {
                name: 'Icelandic',
                locales: ['is'],
                speechSynthLocale: 'is-IS'
            },
            [ITALIAN_ID]: {
                name: 'Italian',
                locales: ['it'],
                speechSynthLocale: 'it-IT'
            },
            [JAPANESE_ID]: {
                name: 'Japanese',
                locales: ['ja', 'ja-hira'],
                speechSynthLocale: 'ja-JP'
            },
            [KOREAN_ID]: {
                name: 'Korean',
                locales: ['ko'],
                speechSynthLocale: 'ko-KR',
                singleGender: true
            },
            [NORWEGIAN_ID]: {
                name: 'Norwegian',
                locales: ['nb', 'nn'],
                speechSynthLocale: 'nb-NO',
                singleGender: true
            },
            [POLISH_ID]: {
                name: 'Polish',
                locales: ['pl'],
                speechSynthLocale: 'pl-PL'
            },
            [PORTUGUESE_BR_ID]: {
                name: 'Portuguese (Brazilian)',
                locales: ['pt-br'],
                speechSynthLocale: 'pt-BR'
            },
            [PORTUGUESE_ID]: {
                name: 'Portuguese (European)',
                locales: ['pt'],
                speechSynthLocale: 'pt-PT'
            },
            [ROMANIAN_ID]: {
                name: 'Romanian',
                locales: ['ro'],
                speechSynthLocale: 'ro-RO',
                singleGender: true
            },
            [RUSSIAN_ID]: {
                name: 'Russian',
                locales: ['ru'],
                speechSynthLocale: 'ru-RU'
            },
            [SPANISH_ID]: {
                name: 'Spanish (European)',
                locales: ['es'],
                speechSynthLocale: 'es-ES'
            },
            [SPANISH_419_ID]: {
                name: 'Spanish (Latin American)',
                locales: ['es-419'],
                speechSynthLocale: 'es-US'
            },
            [SWEDISH_ID]: {
                name: 'Swedish',
                locales: ['sv'],
                speechSynthLocale: 'sv-SE',
                singleGender: true
            },
            [TURKISH_ID]: {
                name: 'Turkish',
                locales: ['tr'],
                speechSynthLocale: 'tr-TR',
                singleGender: true
            },
            [WELSH_ID]: {
                name: 'Welsh',
                locales: ['cy'],
                speechSynthLocale: 'cy-GB',
                singleGender: true
            }
        };
    }

    /**
     * The key to load & store a target's text2speech state.
     * @return {string} The key.
     */
    static get STATE_KEY () {
        return 'Scratch.text2speech';
    }

    /**
     * The default state, to be used when a target has no existing state.
     * @type {Text2SpeechState}
     */
    static get DEFAULT_TEXT2SPEECH_STATE () {
        return {
            voiceId: ALTO_ID
        };
    }

    /**
     * A default language to use for speech synthesis.
     * @type {string}
     */
    get DEFAULT_LANGUAGE () {
        return ENGLISH_ID;
    }

    /**
     * @param {Target} target - collect  state for this target.
     * @returns {Text2SpeechState} the mutable state associated with that target. This will be created if necessary.
     * @private
     */
    _getState (target) {
        let state = target.getCustomState(Scratch3Text2SpeechBlocks.STATE_KEY);
        if (!state) {
            state = Clone.simple(Scratch3Text2SpeechBlocks.DEFAULT_TEXT2SPEECH_STATE);
            target.setCustomState(Scratch3Text2SpeechBlocks.STATE_KEY, state);
        }
        return state;
    }

    /**
     * When a Target is cloned, clone the state.
     * @param {Target} newTarget - the newly created target.
     * @param {Target} [sourceTarget] - the target used as a source for the new clone, if any.
     * @listens Runtime#event:targetWasCreated
     * @private
     */
    _onTargetCreated (newTarget, sourceTarget) {
        if (sourceTarget) {
            const state = sourceTarget.getCustomState(Scratch3Text2SpeechBlocks.STATE_KEY);
            if (state) {
                newTarget.setCustomState(Scratch3Text2SpeechBlocks.STATE_KEY, Clone.simple(state));
            }
        }
    }

    /**
     * @returns {object} metadata for this extension and its blocks.
     */
    getInfo () {
        // Only localize the default input to the "speak" block if we are in a
        // supported language.
        let defaultTextToSpeak = 'hello';
        if (this.isSupportedLanguage(this.getEditorLanguage())) {
            defaultTextToSpeak = formatMessage({
                id: 'text2speech.defaultTextToSpeak',
                default: 'hello',
                description: 'hello: the default text to speak'
            });
        }

        return {
            id: 'text2speech',
            name: formatMessage({
                id: 'text2speech.categoryName',
                default: 'Text to Speech',
                description: 'Name of the Text to Speech extension.'
            }),
            blockIconURI: blockIconURI,
            menuIconURI: menuIconURI,
            blocks: [
                {
                    opcode: 'speakAndWait',
                    text: formatMessage({
                        id: 'text2speech.speakAndWaitBlock',
                        default: 'speak [WORDS]',
                        description: 'Speak some words.'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        WORDS: {
                            type: ArgumentType.STRING,
                            defaultValue: defaultTextToSpeak
                        }
                    }
                },
                {
                    opcode: 'setVoice',
                    text: formatMessage({
                        id: 'text2speech.setVoiceBlock',
                        default: 'set voice to [VOICE]',
                        description: 'Set the voice for speech synthesis.'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        VOICE: {
                            type: ArgumentType.STRING,
                            menu: 'voices',
                            defaultValue: ALTO_ID
                        }
                    }
                },
                {
                    opcode: 'setLanguage',
                    text: formatMessage({
                        id: 'text2speech.setLanguageBlock',
                        default: 'set language to [LANGUAGE]',
                        description: 'Set the language for speech synthesis.'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        LANGUAGE: {
                            type: ArgumentType.STRING,
                            menu: 'languages',
                            defaultValue: this.getCurrentLanguage()
                        }
                    }
                }
            ],
            menus: {
                voices: {
                    acceptReporters: true,
                    items: this.getVoiceMenu()
                },
                languages: {
                    acceptReporters: true,
                    items: this.getLanguageMenu()
                }
            }
        };
    }

    /**
     * Get the language code currently set in the editor, or fall back to the
     * browser locale.
     * @return {string} a Scratch locale code.
     */
    getEditorLanguage () {
        const locale = formatMessage.setup().locale ||
            navigator.language || navigator.userLanguage || this.DEFAULT_LANGUAGE;
        return locale.toLowerCase();
    }

    /**
     * Get the language code currently set for the extension.
     * @returns {string} a Scratch locale code.
     */
    getCurrentLanguage () {
        const stage = this.runtime.getTargetForStage();
        if (!stage) return this.DEFAULT_LANGUAGE;
        // If no language has been set, set it to the editor locale (or default).
        if (!stage.textToSpeechLanguage) {
            this.setCurrentLanguage(this.getEditorLanguage());
        }
        return stage.textToSpeechLanguage;
    }

    /**
     * Set the language code for the extension.
     * It is stored in the stage so it can be saved and loaded with the project.
     * @param {string} locale a locale code.
     */
    setCurrentLanguage (locale) {
        const stage = this.runtime.getTargetForStage();
        if (!stage) return;

        if (this.isSupportedLanguage(locale)) {
            stage.textToSpeechLanguage = this._getExtensionLocaleForSupportedLocale(locale);
        }

        // Support language names dropped onto the menu via reporter block
        // such as a variable containing a language name (in any language),
        // or the translate extension's language reporter.
        const localeForDroppedName = languageNames.nameMap[locale.toLowerCase()];
        if (localeForDroppedName && this.isSupportedLanguage(localeForDroppedName)) {
            stage.textToSpeechLanguage =
                this._getExtensionLocaleForSupportedLocale(localeForDroppedName);
        }

        // If the language is null, set it to the default language.
        // This can occur e.g. if the extension was loaded with the editor
        // set to a language that is not in the list.
        if (!stage.textToSpeechLanguage) {
            stage.textToSpeechLanguage = this.DEFAULT_LANGUAGE;
        }
    }

    /**
     * Get the extension locale for a supported locale, or null.
     * @param {string} locale a locale code.
     * @returns {?string} a locale supported by the extension.
     */
    _getExtensionLocaleForSupportedLocale (locale) {
        for (const lang in this.LANGUAGE_INFO) {
            if (this.LANGUAGE_INFO[lang].locales.includes(locale)) {
                return lang;
            }
        }
        log.error(`cannot find extension locale for locale ${locale}`);
    }

    /**
     * Get the locale code used by the speech synthesis server corresponding to
     * the current language code set for the extension.
     * @returns {string} a speech synthesis locale.
     */
    _getSpeechSynthLocale () {
        let speechSynthLocale = this.LANGUAGE_INFO[this.DEFAULT_LANGUAGE].speechSynthLocale;
        if (this.LANGUAGE_INFO[this.getCurrentLanguage()]) {
            speechSynthLocale = this.LANGUAGE_INFO[this.getCurrentLanguage()].speechSynthLocale;
        }
        return speechSynthLocale;
    }

    /**
     * Get an array of the locales supported by this extension.
     * @returns {Array} An array of locale strings.
     */
    _getSupportedLocales () {
        return Object.keys(this.LANGUAGE_INFO).reduce((acc, lang) =>
            acc.concat(this.LANGUAGE_INFO[lang].locales), []);
    }

    /**
     * Check if a Scratch language code is in the list of supported languages for the
     * speech synthesis service.
     * @param {string} languageCode the language code to check.
     * @returns {boolean} true if the language code is supported.
     */
    isSupportedLanguage (languageCode) {
        return this._supportedLocales.includes(languageCode);
    }

    /**
     * Get the menu of voices for the "set voice" block.
     * @return {array} the text and value for each menu item.
     */
    getVoiceMenu () {
        return Object.keys(this.VOICE_INFO).map(voiceId => ({
            text: this.VOICE_INFO[voiceId].name,
            value: voiceId
        }));
    }

    /**
     * Get the localized menu of languages for the "set language" block.
     * For each language:
     *   if there is a custom translated spoken language name, use that;
     *   otherwise use the translation in the languageNames menuMap;
     *   otherwise fall back to the untranslated name in LANGUAGE_INFO.
     * @return {array} the text and value for each menu item.
     */
    getLanguageMenu () {
        const editorLanguage = this.getEditorLanguage();
        // Get the array of localized language names
        const localizedNameMap = {};
        let nameArray = languageNames.menuMap[editorLanguage];
        if (nameArray) {
            // Also get any localized names of spoken languages
            let spokenNameArray = [];
            if (languageNames.spokenLanguages) {
                spokenNameArray = languageNames.spokenLanguages[editorLanguage];
                nameArray = nameArray.concat(spokenNameArray);
            }
            // Create a map of language code to localized name
            // The localized spoken language names have been concatenated onto
            // the end of the name array, so the result of the forEach below is
            // when there is both a written language name (e.g. 'Chinese
            // (simplified)') and a spoken language name (e.g. 'Chinese
            // (Mandarin)', we always use the spoken version.
            nameArray.forEach(lang => {
                localizedNameMap[lang.code] = lang.name;
            });
        }

        return Object.keys(this.LANGUAGE_INFO).map(key => {
            let name = this.LANGUAGE_INFO[key].name;
            const localizedName = localizedNameMap[key];
            if (localizedName) {
                name = localizedName;
            }
            // Uppercase the first character of the name
            name = name.charAt(0).toUpperCase() + name.slice(1);
            return {
                text: name,
                value: key
            };
        });
    }

    /**
     * Set the voice for speech synthesis for this sprite.
     * @param  {object} args Block arguments
     * @param {object} util Utility object provided by the runtime.
     */
    setVoice (args, util) {
        const state = this._getState(util.target);

        let voice = args.VOICE;

        // If the arg is a dropped number, treat it as a voice index
        let voiceNum = parseInt(voice, 10);
        if (!isNaN(voiceNum)) {
            voiceNum -= 1; // Treat dropped args as one-indexed
            voiceNum = MathUtil.wrapClamp(voiceNum, 0, Object.keys(this.VOICE_INFO).length - 1);
            voice = Object.keys(this.VOICE_INFO)[voiceNum];
        }

        // Only set the voice if the arg is a valid voice id.
        if (Object.keys(this.VOICE_INFO).includes(voice)) {
            state.voiceId = voice;
        }
    }

    /**
     * Set the language for speech synthesis.
     * @param  {object} args Block arguments
     */
    setLanguage (args) {
        this.setCurrentLanguage(args.LANGUAGE);
    }

    /**
     * Stop all currently playing speech sounds.
     */
    _stopAllSpeech () {
        this._soundPlayers.forEach(player => {
            player.stop();
        });
    }

    /**
     * Convert the provided text into a sound file and then play the file.
     * @param  {object} args Block arguments
     * @param {object} util Utility object provided by the runtime.
     * @return {Promise} A promise that resolves after playing the sound
     */
    speakAndWait (args, util) {
        // Cast input to string
        let words = Cast.toString(args.WORDS);
        let locale = this._getSpeechSynthLocale();

        const state = this._getState(util.target);

        let gender = this.VOICE_INFO[state.voiceId].gender;
        let playbackRate = this.VOICE_INFO[state.voiceId].playbackRate;

        // Special case for voices where the synthesis service only provides a
        // single gender voice. In that case, always request the female voice,
        // and set special playback rates for the tenor and giant voices.
        if (this.LANGUAGE_INFO[this.getCurrentLanguage()].singleGender) {
            gender = 'female';
            if (state.voiceId === TENOR_ID) {
                playbackRate = FEMALE_TENOR_RATE;
            }
            if (state.voiceId === GIANT_ID) {
                playbackRate = FEMALE_GIANT_RATE;
            }
        }

        if (state.voiceId === KITTEN_ID) {
            words = words.replace(/\S+/g, 'meow');
            locale = this.LANGUAGE_INFO[this.DEFAULT_LANGUAGE].speechSynthLocale;
        }

        // Build up URL
        let path = `${SERVER_HOST}/synth`;
        path += `?locale=${locale}`;
        path += `&gender=${gender}`;
        path += `&text=${encodeURIComponent(words.substring(0, 128))}`;

        // Perform HTTP request to get audio file
        return fetchWithTimeout(path, {}, SERVER_TIMEOUT)
            .then(res => {
                if (res.status !== 200) {
                    throw new Error(`HTTP ${res.status} error reaching translation service`);
                }

                return res.arrayBuffer();
            })
            .then(buffer => {
                // Play the sound
                const sound = {
                    data: {
                        buffer
                    }
                };
                return this.runtime.audioEngine.decodeSoundPlayer(sound);
            })
            .then(soundPlayer => {
                this._soundPlayers.set(soundPlayer.id, soundPlayer);

                soundPlayer.setPlaybackRate(playbackRate);

                // Increase the volume
                const engine = this.runtime.audioEngine;
                const chain = engine.createEffectChain();
                chain.set('volume', SPEECH_VOLUME);
                soundPlayer.connect(chain);

                soundPlayer.play();
                return new Promise(resolve => {
                    soundPlayer.on('stop', () => {
                        this._soundPlayers.delete(soundPlayer.id);
                        resolve();
                    });
                });
            })
            .catch(err => {
                log.warn(err);
            });
    }
}
module.exports = Scratch3Text2SpeechBlocks;
