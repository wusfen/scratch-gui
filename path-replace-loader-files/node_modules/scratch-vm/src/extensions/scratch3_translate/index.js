const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const Cast = require('../../util/cast');
const log = require('../../util/log');
const fetchWithTimeout = require('../../util/fetch-with-timeout');
const languageNames = require('scratch-translate-extension-languages');
const formatMessage = require('format-message');

/**
 * Icon svg to be displayed in the blocks category menu, encoded as a data URI.
 * @type {string}
 */
// eslint-disable-next-line max-len
const menuIconURI = 'data:image/png;base64,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';

/**
 * Icon svg to be displayed at the left edge of each extension block, encoded as a data URI.
 * @type {string}
 */
// eslint-disable-next-line max-len
const blockIconURI = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAABYCAYAAABxlTA0AAAcOUlEQVR4Xu2dCZQcxXnH/1XVPcfeWi3SSshIMhiJU4YESdwW4hDiEAgs48QB7DjGDxtiILbhBRwl5rCNhWM7JITElsFHYhEcwIARIMvC4pCEBOY2upZLQtLuau/dmemqyvuqu3q659idXe1i+0Xz2Kfd6e46fv3Vv77vq+qGYf9nTAmwMS19f+HYD3iMjWA/4P2Ax5jAGBe/34L/UIDvWjf7zx1HzGUaNVqB8aAhCkCp32076Xj+E/+ruC/ljhd/ryBLoFCA+U9Bc9WrlV5/5ZzX14FBjzG3iosvsuA71x/3oSQT9zCweYIJMAawcC60p9v209/5vvi/FfbN/h09L3pO8fF8GbbEwnOC77X9V0FqDakkPCWf1dr7q6tP3LK1YgpjeGIM8LdX/1lTfbWz3uHOdIcLCM7BiHAEcb4tg4HVPiNTenAefcWC78ObUB6uLntOFLp/ltYaSimCi6wnkVPeju6Bvtk3zn/3vTFkV1HRMcB3rz/uTsHcK5OOA4c74IwZwJwJHDbhUiRFHYo6rukbv9Md/VvQ0vEoZjV/ASl3PNa/czPCoR1YW9Q64xYfhz0Y4Ogx8zsB1joEnMl5yOrcT687adunohRWbb7qzN3dr9yRk727XZ7c6IjEGu3K3yw54jc9FdEawUkh4KWr4Uyumr0nKRINCceFI4QBTBqRFA04+9CfgDN30Cp6sjuwcvOlOG/mA3B5FR59cwkGvLZAOIytBdcX/1sOdhy0HQ3F0uFbsEJOSgzkPAx43sDOvp6mb5+1q9c2+qcbTrq/vW/bYkYjCQyCu0i41X0OS6103eS93TL7yBV/vjE3Ao5lLwkB/9szsw503fS7CeGCfkgeOA8OayDp1MPhVQY4cfKPBMeDfwa8duRkN+qS0+DwNNr6Xy0L1BeP0tDzsIslJXYs1HzfgmUAmCx4wPOQlfLwr5761uu297c/0fyxnJZ3CM5mJgRPO8IfodR8zhy4bvodR6S/V5XO3rXkiNdGxapDwP/y9DFT04lUC8F1hQMhuG/B4dAmnjr4c7BJKm9zcYsdfMLycVvtjoKNa64PKz8CbG2kwyFgj6w4h0x/7ujrz3j35ULzunw5UhPH1R6bToizkq64MOU6R7qcMzvfuE56tyvcf3yr9/W7l86Dty8WXQKwUxZwFJ3fyTjo8poaYihp0eVloNR1Zb7TiFiwREaSFeeOvv7UYsCFwG56tOqYpEh9Pu26n0o6vMq3ag4hki8Il/31Z4/b8sJIIRcATgYWLHwLNg7l4NaaH+pxy7KWFtqf+UXD17/oVXFdtTeulBSUmviKLVghSxIhJTJ9XkkLLgfry49UNzeI5PVVSffzruBJM8FzJ8sE+/vPz3lr2Uj86xKAyYKjLlohYL9LvgdcetIqtMgpdfNx7KTrzPnr37kV7/c+FRQQvb60ZRbfwFJS40uXlYhsThoNzvSrYQG24Jc+UntoOpX81yrXnW9kkuyZ4392tevLlp63o2841lwAONFC+psgDTY+cL57/olRCJXAJQlXOOPgH2Nc+iOmhPc7X8Rv3v4b5OfPOORyQEONthocjIiYBWsFTypkchIZTyLTnzn6+jN2FWlwhYDYbU+M/0JVwr3d4TxlruF4hqnec688uXNvhWXk05U0yaUSbgvBNZMceRERwOVcrKE8Aa0lzjn0QdQkJps2tXVvwePbPw7ORZHbVlxWiQnORm8Fo0dpBaU0clKZYMN4EWaSGzFg097bnqw7LuWk/9cV4sBA2jbmvP7Tr5nX0RGFvGbrV4/a2bnpl+1927fu3rHl7KVLkKXjMQtOJZwAsJWIaBHFLlXM4dc2fxAfwhoS5x76EGoSfvtaCfC2i8C5zWjky6Xy/FFTMFoKrNXebHO+dfYCL8JYsEc/clQAU0uWrWn8kAP3ccHETGqegnpK97x/5tULkbGt/cVLi27bsXfD9QOexM623iOWLel5rQRgUQZwqYkp/93E6uNxzKRrkBB1JUdOQtSCBekipSWysrsg+PbL8lQ/Xt51N7Z33BdCzqMevA1Kw4TLvgUrUEd7+72jv7aPFmw79K3VBzSnhbOGM3Yohfw5Ke+55tTdl9vjP3/xtF/s6Xr9wt4BT7b17xn3rUXoLgB82NRkoioGeGiJoMlF4cxDfoqGlK+x+/rJer1Y8coccEcFhhq3cGvdRpPNbOv7zMYPpnDZarBU6O2XowaY6v3O6uZprsueZUAzVZqR8rPXnrrnB3TsZ5tOeK29t+Ww7v7M2zec2TbVcohIBAFOtyS4A9chifCjnLi/WzCDmzwEScDDqE407ytbc71SEj998RgIlyLWYg0Og5FYsJFP+OSkNhpMMtE7oEYVMLXve2snnexwvQpgrtSqp6d/YNbBk858d6B/e2d3/47U3t6BJ25c0H5mGcCpFpc7SDjChMl2po/N4GQ2kawY5WLPM4AnmTJ3db6MtztXRSJAhaMnfxZJt94c78204dWdPwQjDQ60dfr4BWiqOTIC+KPgrpkj4pAjCaPCoIZC5fwk5+tw34AedcDUoruenXSjBr5Ovw943sojJp9z1Xvt69/sHdiL1u7+f1m6sOOqMoCTLS4XAWDfiwhn9gCG7wDnLYu8hPNmPBoCfn3nffhd2y0hHP/4Y6hJTDHftXZvxmPbzjdeii17zpRbcPC4xSHgn7w4C4IA0wgJ6yv2k0PIRiUigHMKGUmAs0d/7Yy9I3XTyo5IkxirPnCdUvJYkqW61MF39w3s+Fw2l8Gu7t4v3nxO150lAScSiZYEFxGJsJyiE0zcb6VJ6/wZj0UArwgA+7kF0ujzZ6yMAf7VtnMNYCsBcw68BQc3XhQBfJRvwaH3kLfkmC8e3mgrERo5RZGcb8H9mdw+AX78zSs/2dr98m2e6t/uiqp1jlu1PpVw1p034+H3frBp6vHSk2ullFwwV3syx7I5jR3t3Wd+a3HvE2UAuyFgIxFB2szvh51s4gGGD3hlDPCLbWb0+IGJOf5EAeCFMT947pRbcfC4POAfv3CkseDCSLFQf+NuIkVy1g8mT0LvM+B71s19smvg7fkU3gdhMxJuWjs89Z7rpNdlVe9J/QOtEw0ZBfRlJHZ2dx90xwX975QB7PgSQXkIM8nFLSdAFs9mBQCtBm/e/Uu80v6d8IaQBZ918M/DG9Desx2r3vpUzIKPnXQDpjWcE1rwj184ItBgfxRYS87XH96+4JcgVDZeBE1yvgUPZMhNG7lE3L5y4mlZyFsdzmclHJZybIaR5iCzlBZWD60Zugey3Zv2to67b0l+ATHmRSRc0UJ5CFfwwIvIW25+Uim24EUznkB1EKmVFa4KD5AXce8Lh4O7vg9P7pfFaYuIQw+U3OQi8oCNL5wlN23kgG1916xA2hV1s5IpzE4Id44r2BxHsOmuEJy8LZooqJkdfZkXbjq77dhoVyOAp0913XRLIgBMkZaf+SrOOcSHpsSiGatGF/CmmWAlvYj8iIp6EXQT6G/fi/AtmCQiM0qAS9nGDStqDkCaH+dyPtsVzhwGHNIzkLvxGxd0/nwQwKmyFlwkD4FlkQYvmrkqDIUrNNSyp9HK8L2bZkQkIj8OY65ZADWv9RELNuGyRjZLfvC+W/C+9KnAgpMtJA/0Y/3g2ERTItFCx+dN/U9MrjvJtGN762psbV8RTHFk/wonTbsFVYkm811X/w48+9Y/BKGzj2zmhEtw0LjTzO+7Ol/Fw1vOgnDyqyn5NkQlI5IuDSM5mEiOrNf85P7IADsupSt9wH4kV2qCKc4JpMRETKu9GFLmsGXvCijhL3QavFriwpm/RW3yQ+ab1u438fCW+WGyh+A5rBaTqk4HRwJvdz5uri/0cYMEdFBqcDSynOXng60Gawx4CufUJq4/Mu28uy8WOPi1EpBMezmvrTfnPTt+bntX4fkxC3Zc1wdMqUpBC4F+UBHTu4KFynKhaxjmGsBrY4B/ueW0WDYt7wZGg2N7c/PiFDY+0ibL2ALOSSBHLlpO4TPj0zjAtVm7UcZsfXSloaW5uz0yp5atH9h987zIOl4MsHBFS4IHEiEiucxYot1ONAH4WPganxCNk6UkFh/2TAzwQ1vmgZvsWvzW+eZpo7cIWJPUKZAHCzm4D3kLhu8D5xQ+11yNCYlBAJuwP0RQ2R2wXbStVxpKasichMxI6Jz8We3JrX9pCwtL//bT06dWu7yFrNcVtERSyg8uXFUuDl/DLFdEIi467Nk44M0f83MRkfW+vDtWADYabhRAtS4ycaJ+S0mbTwCKqAZyElccdRMmVvmJ/jBQooig84cABDDhW0DncqDnocrgFp4VaD9ZsPSUAewNeGBZeXHtae330+lxwA4zEkH7BUINLlx7C8PXYmstFRBQJEcWXJf0M3h7ut6AseAAcHRXgJWb2KQWUDQOY1ClARr9PTjma7AvEbT55PPHP43m2sOL4e35GqD7gQm3A90PAHuuiaIYFmzjIkYA5wY86Iy3sn5e+4ICwJOmVjlRLyIYPWUyWHHvwlpdZPzYfC0UTpt+Lw6qn28a/sbOh/D0zivCVGh4RZCwsb3z76M/YmykbiFH//VzwRELJsCSACtcOf3DaE6lgyLDuAvwaN7jQPpkYGAToE1ufEQfA5hkIqfgZcmCJVTG21H/sTazhBOxYAKcaKFw0KU8BMlELB8bGbqR8DXmm4ZQ49qaEhPwkYZLIaXE663LIUV7vjMRfzaEGozoIqsNLNUCtZZsz6NAI7RgT+GLU2vQnKS1vzH8BCspiiQiq5DrNxa8p+5jbROKAKcdN6LBVv8tLDsmi6110HxB1JWymltorda/HsJazWmRSa0QtJUIykdQLuKqaR8kYA1pLNgjC95Td2oJwCmHkj0sCDR8Ny0Kr7S1lgBeCmpolZFSAust1NPosC+EWAQ4AO6vyQUWHITLV0+vwaTUB2XBQwFeNWlqqlq0OAYwg6CNcSXcqOFaa9w7yLta4fCPWmSJiaycHBR9HwQaJmVJUZzU+NKH/8gAJ6qYLxEOg/B3rvr+ZzDhlPJbS7pXdoIKpC/vHcSHuC02BiuqswVeQzi5RSY2q8NkwQQ3CvjaQ2owuZQFRxwg236z/mhnpOG4xqEGD2HBN68af2B1KvEuWS/9OJwA20pp/0E09o86UpHvY+nFiLVGrLTQd41OVHSMdleEbljwdygZkXIIqC3LyoNSNulOFqzw1UNr0VwImMqgC1KnAFUnAzID5N4Hsluh+58DczUYaWOlkCsFTOtMVXxia8Jh9QawCTb8esJgJ7IeF2K1PpR15UM/OQ4gBGl2o+chhsZUwiqj2myuCXQ8hEudsxpMD8PQ0r0JNnzX6daj6pHMr9z644nOr7oYrPmbRVGc7lwL/fZlYCl66qdCyJUCprq/sabpLg5+RcLxAQuOMPEe3lC7OzIK0lp3CUslq1JmQZImIR9s1Epjfu4gHkLoCxfdiPwNMxJhIANH1zv4zPTquH9mrFcA09aCuRNL+m7qzSsAbyV4MrCuoTy84QBeurJmQiKZ2iAYO8haMUkFgTZ7Zs1NLVgpK5ETiFqav/McUJR4MkvrvtXR9+W8hVLaXPK76M0ieQiW7tOC4Ssza9FYmIegKtPngk3+Xlls6r0fAG1fB6/i+efVBoM8HMBUztLVDdNcOD8RDCeSFScEjEdhJj2bn6jEbw0gElybIyD/1MCmIVzG5y3U6OjfIWQ71GMW71vygWmOy6dXF2svjTJPA1PuB6vKr+qoztfA6/PhtO7YALX1IvA6AUadHuozXMBBeezmNY3HJzmf6wgsETBrUKEmRztaKkdgZCCwXIJKP5RGVFr/Tik84MsG7Yb0azskLWZNccUFFD36wyTfsWiYbPsakf1AVjUSjGFqtYNDaoKHdwrB0M0QR4FNfSAsXysP6uUvQMz69/Bs7fVAbToavF6DUdJ/KMYjBBxWePvT468Wmn3Xz7BR8OHXWOha2eFuJ7DQZQpyA1LqbI6p2d9c0PG7wr57Lx14uQRbLlwO7nB/ghnlj/Ecmu4Aa7gwLFm1rYHaci2c2c/Hbqp8cT54chtY4gMAfPPqxrlJwZ61GTbz7FzEY4j5pmbh0ZcAkgLfcv0fBX3jNxbutVt+YvjGHLCRkiaw6WsBngjrlm/8LdDzIPgxr4CJmjz4N78EZB8AT1cw0e2rBS99FYnknvGtLme1RiaMcQVWXBAUWH+UEvx5aTCwn9zW174gul8gSnjMAZP3Un8V2AGUlvQ/2uuDev7PwKr6wD7yOFh6Rh4wTXStXwerZkOPpn0FTLXe8uvxDwqO8ymMtrsuS4WqxbpLey/1Oxkve9x3F/XuKjfqxxSwcc0cYNrTYO4BeYjvPwD97t+CVzNg8r+B1Z+dh9/5PNQWmuj40BPdaAD+xyfHXyYYfhSudJim5LU4GkmRk2+tlzY4Ki5PWXZu58bBJHXMAacXgU2m3Ub5j3z5UjD9FFiKAY3XgzVdUXqic4eYD0YD8FceRG1VVeO7DmN11oL9ZxRpR4vvHtkw1eiunxPwlNYX3bGoY8j1mLEEbBYkpzwAlp6VB5hphdo4G6xBgbscuuoTYAfeFr8BlU50owGYar5pZePtHOzvCLDV4Wii2/i7ZL0+XAnov162qOOeSpyBMQNM8uB8FOyg++OuX/cbULvuBRO7weQuaDENfPr3Y01VlU50owX4ul/WNqUc93WmWZOfo/CTmcbntV4DLZ1AZxiTn152ftd/VQKXzhkrwMZ6J3wXrP78SpsSmeh+CLT+E3j1EBHdaAGmmr/6WMMi7fH7KXouAuyvsO70tP7k9xd3rBlOj8YEsHHNJoB9+Le02384zfG9jM6NUFsuHDqiG03AVPF1j4z7JDz271qj1jTEz0XkwPQ9Qsgblp3X3Trc3owJYHLNGr4E1nT1cJvjA/Z6oTYdNXREN9qAqfK/+0XNhKwQiyExhQFvZbzso3ct6R/x20VGHbBxzVxg+jNgzvg8YK0gX/8yWCIJpCYB7gQweraEftJTwSJBCF0kXzwDPLEFLDlIRDcWgEdkEoNcNCaA0xeATb4jPnHtXQf9xsfBaoIIjSaRYOsTm7wUvPkzBRPdNUD2fweP6P7fAh5/K1jDJXHX6/dfAetfEY/Q7ApHzV+BTf6nOOD3KpjoRhOw9h9VsIsQo2bIY2PBl4BNvjUSPPRCbZwDVttTnEwnyO4pYAf9KNYn3bEeatvHwWsHiehGC7DcUH+z1uxqQP+eMbZOK7Xey+l1yRO7NzNmFilG/BkTwJ6GTi0Ca7wMEPVQb30TbGClb70mLRpprvGAmsEOfjruL7evgWq5dOwBk+WqjfWtmqHR9xxIu/wWMq3btMZGgK1jTK0TntrATuzZPRzaBrDGcp4QJl0ZvitoOIUUnkvQCHKW0noatIpL6cdyOV5NuwYbvw42nl5UpaF7XoPadh2Y+D14ahBfuNTOnmyJjSeD9UWvr25WCWeHjS5og6ImwMEam+/X+I8ymQfjPLZVed5n0/N7nqqEEQH2NJYLCzi6hF5JAeXOCVaew8PBNoSSp1Nfcgraa4DOeYDuAksGN6XQ4qMFRAB7Znel2Zu2p75w69SggDfVnKK4WBO8cAoUCHPGVmtPb1aKzdFaHw7NXLOoSUGyZBDQP0rO6/h0JXy8l5ov95RYLhL5hLv/nPQH+LHbAMK1LH+JzF9WL9+O2O7KrAz2psk99fMKtk4NCvil+r+RHu62L7CkBUym2N7+rDez9sSe3Xo1arxEzbGcidmex+YoySYpKa+pPr1rQyWIvBeaL89pvlwkBUSwohHbCFJJIZWcM8rTs/8kKxmUhvJ86zV707LenobT9sY3/w3WPrmpbpnW7FrzVlCN+7VkFxk5UPpnieM7w93clfSx1DnZDRMuzYHfQxIhXNLh4El/+97MkRqzCZft6qpfc2Tb3EibG1xnV8WD/cG0fTXYgI2st6vhjA7z+oGKmu493/Cw1jiHVMpRapLkfL1S7MOU2dFK/UXyxK7/3pfW7n2q6VTXFb/hCR4A9t0if/0zD7viOiJgzRAO17Wie+orLq34RLsnJChXefQIQbDDPeNB5eT6pgWdc4YBuH6zkuwQDr3VmdN5SO75mnmQ4gmtmYBCl+be8cm5/itURvLRz8Pt7mvaxlwxhXTYWDEBpp/gvRXDkQyz3ywIIMzmaH8jRrAla5R0wk9u+ZuvSSIIMG1fzUhwJb88fmH3tysCrJ9B2hP1HUoyWi18JHlCx7l0IfnFUrG/J6lg0NtzMndS9Ul9O0YCmK7p+HXjRUzwFdzlnNw1WmE2ehxqcrBXbogKLFyz94I6LhXIwrRUBsboSIQdFf4+N1MHAc4pMKlf6e/tnP2hJeivDPBzNYfntPOqohcManwndUrHtUbLVkDI6fUPKcUWEmSu1auZjDy9Zl7v+yOFvHd1w2WcO99nDq+lCc+xblugyUMu5xdaFe06zxFgCZXzX4EbuJIjbWJ4nZUdO8nRDQT0WuS8TxywKG9oQ2pw7pm6BdLjvyIXLMH155xTOv/D1rJnLWobkvWrtGLHUUVM681K64WpE7q2jLQH76+smVBXnVzCEs5RPCGWMIc3mOBDDLFfwsKNPpSSlWZbPw1dptWzkPg9vf5r3+LOfM9M+ErWq3WrC/XEP6/vfXLp0njpQwLevRo19Xzcf2ut09lu+Ym6gnyvXlc7XnH+uJTsWFI3iuyY1n/pntC1cqSQ7XUDmyY9AsEXmgDEbHwps0+hAC5Jghc8t2aeXfPUrt6u3BFTFnfbR1D3tWkVXz8k4EpK0qsbGmQNfqEU5gXrSJIx/LOjOm9iJ/haNJJPZmPzUsX5Pxj3jbQ4eB1tYVnWU/D9UZIF/6FAmnBkVmqu9OJxZ3U8MJI27Os1owI40OSEnF7/Xa3YFZS7MA3Teitn6jpnbveDI2lo//qJ8yH4k3bSMzJREEZH4ZIOGncpeJzKy3g06dzZuKDjiyOpfzSuGTXAtjHec3WXaMbu1JqZxBB9GMMzDOpW8auuX7ECjRqsE+88g3STO3E3c50aP08RuG3h/QtexiF9L8E+bWmtV0u5rl12nvqRyBv6RgPacMoYdcBUee9TVZPchLuMMfYJrcP/KwQ9vf8mZ1iey2BF6uTObZU0tO+5CffBFRcbj8INZCIKOHDHDFya0DKekQaVUzvgZmY3zR/5UlYl7RvqnDEBbCvV62qP9zS/GWDzwreSk0VzWhxjr2mF1QA2SE+vTZ/aub1UY3t/23QeEs5DYZQXyWz5Wb3AFYs4+tpTXUJn5zUs6Ns0FICxPj6mgG3js8/VzQXY1QzsAg34z7YG6U1KHHHN+uQAm1l1Vnv4tqbwJq2A6J1ywKvMETPIgn13Ldg+a6MocscCwDKr+l3tnduwsOfXYw2vkvI/EMAhrJfqx8k+daHW4gIApyiFekVvUDRGKA+vO737zVKN7n6q8WLFxH1RwOaJJALsBVFUltwx3QXtXdj0RwLXzD+V3IWxOIfyD329DUcmOY7SHtvmztu7drB6Olc3/pdi7BLrSeTzAD5g47Fob3Hj2b0vjUV7R1rmHwzwcBu8fTVSDbLhJ0qzi0z2I0i0MK1zgP4PprtuGL8QRa90GW49o33+nwxg2/G2x+oWMI1zNVANrV9lXm5F4/kDb482mNEq708O8Gh1/IMqZz/gMSa9H/B+wGNMYIyL/z/1ePh228U9YgAAAABJRU5ErkJggg==';

/**
 * The url of the translate server.
 * @type {string}
 */
const serverURL = 'https://translate-service.scratch.mit.edu/';

/**
 * How long to wait in ms before timing out requests to translate server.
 * @type {int}
 */
const serverTimeoutMs = 10000; // 10 seconds (chosen arbitrarily).

/**
 * Class for the translate block in Scratch 3.0.
 * @constructor
 */
class Scratch3TranslateBlocks {
    constructor () {
        /**
         * Language code of the viewer, based on their locale.
         * @type {string}
         * @private
         */
        this._viewerLanguageCode = this.getViewerLanguageCode();

        /**
         * List of supported language name and language code pairs, for use in the block menu.
         * Filled in by getInfo so it is updated when the interface language changes.
         * @type {Array.<object.<string, string>>}
         * @private
         */
        this._supportedLanguages = [];

        /**
         * A randomly selected language code, for use as the default value in the language menu.
         * Properly filled in getInfo so it is updated when the interface languages changes.
         * @type {string}
         * @private
         */
        this._randomLanguageCode = 'en';


        /**
         * The result from the most recent translation.
         * @type {string}
         * @private
         */
        this._translateResult = '';

        /**
         * The language of the text most recently translated.
         * @type {string}
         * @private
         */
        this._lastLangTranslated = '';

        /**
         * The text most recently translated.
         * @type {string}
         * @private
         */
        this._lastTextTranslated = '';
    }

    /**
     * The key to load & store a target's translate state.
     * @return {string} The key.
     */
    static get STATE_KEY () {
        return 'Scratch.translate';
    }

    /**
     * @returns {object} metadata for this extension and its blocks.
     */
    getInfo () {
        this._supportedLanguages = this._getSupportedLanguages(this.getViewerLanguageCode());
        this._randomLanguageCode = this._supportedLanguages[
            Math.floor(Math.random() * this._supportedLanguages.length)].value;

        return {
            id: 'translate',
            name: formatMessage({
                id: 'translate.categoryName',
                default: 'Translate',
                description: 'Name of extension that adds translate blocks'
            }),
            blockIconURI: blockIconURI,
            menuIconURI: menuIconURI,
            blocks: [
                {
                    opcode: 'getTranslate',
                    text: formatMessage({
                        id: 'translate.translateBlock',
                        default: 'translate [WORDS] to [LANGUAGE]',
                        description: 'translate some text to a different language'
                    }),
                    blockType: BlockType.REPORTER,
                    arguments: {
                        WORDS: {
                            type: ArgumentType.STRING,
                            defaultValue: formatMessage({
                                id: 'translate.defaultTextToTranslate',
                                default: 'hello',
                                description: 'hello: the default text to translate'
                            })
                        },
                        LANGUAGE: {
                            type: ArgumentType.STRING,
                            menu: 'languages',
                            defaultValue: this._randomLanguageCode
                        }
                    }
                },
                {
                    opcode: 'getViewerLanguage',
                    text: formatMessage({
                        id: 'translate.viewerLanguage',
                        default: 'language',
                        description: 'the languge of the project viewer'
                    }),
                    blockType: BlockType.REPORTER,
                    arguments: {}
                }
            ],
            menus: {
                languages: {
                    acceptReporters: true,
                    items: this._supportedLanguages
                }
            }
        };
    }

    /**
     * Computes a list of language code and name pairs for the given language.
     * @param {string} code The language code to get the list of language pairs
     * @return {Array.<object.<string, string>>} An array of languge name and
     *   language code pairs.
     * @private
     */
    _getSupportedLanguages (code) {
        return languageNames.menuMap[code].map(entry => {
            const obj = {text: entry.name, value: entry.code};
            return obj;
        });
    }
    /**
     * Get the human readable language value for the reporter block.
     * @return {string} the language name of the project viewer.
     */
    getViewerLanguage () {
        this._viewerLanguageCode = this.getViewerLanguageCode();
        const names = languageNames.menuMap[this._viewerLanguageCode];
        let langNameObj = names.find(obj => obj.code === this._viewerLanguageCode);

        // If we don't have a name entry yet, try looking it up via the Google langauge
        // code instead of Scratch's (e.g. for es-419 we look up es to get espanol)
        if (!langNameObj && languageNames.scratchToGoogleMap[this._viewerLanguageCode]) {
            const lookupCode = languageNames.scratchToGoogleMap[this._viewerLanguageCode];
            langNameObj = names.find(obj => obj.code === lookupCode);
        }

        let langName = this._viewerLanguageCode;
        if (langNameObj) {
            langName = langNameObj.name;
        }
        return langName;
    }

    /**
     * Get the viewer's language code.
     * @return {string} the language code.
     */
    getViewerLanguageCode () {
        const locale = formatMessage.setup().locale;
        const viewerLanguages = [locale].concat(navigator.languages);
        const languageKeys = Object.keys(languageNames.menuMap);
        // Return the first entry in viewerLanguages that matches
        // one of the available language keys.
        const languageCode = viewerLanguages.reduce((acc, lang) => {
            if (acc) {
                return acc;
            }
            if (languageKeys.indexOf(lang.toLowerCase()) > -1) {
                return lang;
            }
            return acc;
        }, '') || 'en';

        return languageCode.toLowerCase();
    }

    /**
     * Get a language code from a block argument. The arg can be a language code
     * or a language name, written in any language.
     * @param  {object} arg A block argument.
     * @return {string} A language code.
     */
    getLanguageCodeFromArg (arg) {
        const languageArg = Cast.toString(arg).toLowerCase();
        // Check if the arg matches a language code in the menu.
        if (languageNames.menuMap.hasOwnProperty(languageArg)) {
            return languageArg;
        }
        // Check for a dropped-in language name, and convert to a language code.
        if (languageNames.nameMap.hasOwnProperty(languageArg)) {
            return languageNames.nameMap[languageArg];
        }

        // There are some languages we launched in the language menu that Scratch did not
        // end up launching in. In order to keep projects that may have had that menu item
        // working, check for those language codes and let them through.
        // Examples: 'ab', 'hi'.
        if (languageNames.previouslySupported.indexOf(languageArg) !== -1) {
            return languageArg;
        }
        // Default to English.
        return 'en';
    }

    /**
     * Translates the text in the translate block to the language specified in the menu.
     * @param {object} args - the block arguments.
     * @return {Promise} - a promise that resolves after the response from the translate server.
     */
    getTranslate (args) {
        // If the text contains only digits 0-9 and nothing else, return it without
        // making a request.
        if (/^\d+$/.test(args.WORDS)) return Promise.resolve(args.WORDS);

        // Don't remake the request if we already have the value.
        if (this._lastTextTranslated === args.WORDS &&
            this._lastLangTranslated === args.LANGUAGE) {
            return this._translateResult;
        }

        const lang = this.getLanguageCodeFromArg(args.LANGUAGE);

        let urlBase = `${serverURL}translate?language=`;
        urlBase += lang;
        urlBase += '&text=';
        urlBase += encodeURIComponent(args.WORDS);

        const tempThis = this;
        const translatePromise = fetchWithTimeout(urlBase, {}, serverTimeoutMs)
            .then(response => response.text())
            .then(responseText => {
                const translated = JSON.parse(responseText).result;
                tempThis._translateResult = translated;
                // Cache what we just translated so we don't keep making the
                // same call over and over.
                tempThis._lastTextTranslated = args.WORDS;
                tempThis._lastLangTranslated = args.LANGUAGE;
                return translated;
            })
            .catch(err => {
                log.warn(`error fetching translate result! ${err}`);
                return '';
            });
        return translatePromise;
    }
}
module.exports = Scratch3TranslateBlocks;
