const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const Cast = require('../../util/cast');
const log = require('../../util/log');
const fetchWithTimeout = require('../../util/fetch-with-timeout');
const languageNames = require('scratch-translate-extension-languages');
const formatMessage = require('format-message');

/**
 * Icon svg to be displayed in the blocks category menu, encoded as a data URI.
 * @type {string}
 */
// eslint-disable-next-line max-len
const menuIconURI = 'data:image/png;base64,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';

/**
 * Icon svg to be displayed at the left edge of each extension block, encoded as a data URI.
 * @type {string}
 */
// eslint-disable-next-line max-len
const blockIconURI = 'data:image/png;base64,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';

/**
 * The url of the translate server.
 * @type {string}
 */
const serverURL = 'https://translate-service.scratch.mit.edu/';

/**
 * How long to wait in ms before timing out requests to translate server.
 * @type {int}
 */
const serverTimeoutMs = 10000; // 10 seconds (chosen arbitrarily).

/**
 * Class for the translate block in Scratch 3.0.
 * @constructor
 */
class Scratch3TranslateBlocks {
    constructor () {
        /**
         * Language code of the viewer, based on their locale.
         * @type {string}
         * @private
         */
        this._viewerLanguageCode = this.getViewerLanguageCode();

        /**
         * List of supported language name and language code pairs, for use in the block menu.
         * Filled in by getInfo so it is updated when the interface language changes.
         * @type {Array.<object.<string, string>>}
         * @private
         */
        this._supportedLanguages = [];

        /**
         * A randomly selected language code, for use as the default value in the language menu.
         * Properly filled in getInfo so it is updated when the interface languages changes.
         * @type {string}
         * @private
         */
        this._randomLanguageCode = 'en';


        /**
         * The result from the most recent translation.
         * @type {string}
         * @private
         */
        this._translateResult = '';

        /**
         * The language of the text most recently translated.
         * @type {string}
         * @private
         */
        this._lastLangTranslated = '';

        /**
         * The text most recently translated.
         * @type {string}
         * @private
         */
        this._lastTextTranslated = '';
    }

    /**
     * The key to load & store a target's translate state.
     * @return {string} The key.
     */
    static get STATE_KEY () {
        return 'Scratch.translate';
    }

    /**
     * @returns {object} metadata for this extension and its blocks.
     */
    getInfo () {
        this._supportedLanguages = this._getSupportedLanguages(this.getViewerLanguageCode());
        this._randomLanguageCode = this._supportedLanguages[
            Math.floor(Math.random() * this._supportedLanguages.length)].value;

        return {
            id: 'translate',
            name: formatMessage({
                id: 'translate.categoryName',
                default: 'Translate',
                description: 'Name of extension that adds translate blocks'
            }),
            blockIconURI: blockIconURI,
            menuIconURI: menuIconURI,
            blocks: [
                {
                    opcode: 'getTranslate',
                    text: formatMessage({
                        id: 'translate.translateBlock',
                        default: 'translate [WORDS] to [LANGUAGE]',
                        description: 'translate some text to a different language'
                    }),
                    blockType: BlockType.REPORTER,
                    arguments: {
                        WORDS: {
                            type: ArgumentType.STRING,
                            defaultValue: formatMessage({
                                id: 'translate.defaultTextToTranslate',
                                default: 'hello',
                                description: 'hello: the default text to translate'
                            })
                        },
                        LANGUAGE: {
                            type: ArgumentType.STRING,
                            menu: 'languages',
                            defaultValue: this._randomLanguageCode
                        }
                    }
                },
                {
                    opcode: 'getViewerLanguage',
                    text: formatMessage({
                        id: 'translate.viewerLanguage',
                        default: 'language',
                        description: 'the languge of the project viewer'
                    }),
                    blockType: BlockType.REPORTER,
                    arguments: {}
                }
            ],
            menus: {
                languages: {
                    acceptReporters: true,
                    items: this._supportedLanguages
                }
            }
        };
    }

    /**
     * Computes a list of language code and name pairs for the given language.
     * @param {string} code The language code to get the list of language pairs
     * @return {Array.<object.<string, string>>} An array of languge name and
     *   language code pairs.
     * @private
     */
    _getSupportedLanguages (code) {
        return languageNames.menuMap[code].map(entry => {
            const obj = {text: entry.name, value: entry.code};
            return obj;
        });
    }
    /**
     * Get the human readable language value for the reporter block.
     * @return {string} the language name of the project viewer.
     */
    getViewerLanguage () {
        this._viewerLanguageCode = this.getViewerLanguageCode();
        const names = languageNames.menuMap[this._viewerLanguageCode];
        let langNameObj = names.find(obj => obj.code === this._viewerLanguageCode);

        // If we don't have a name entry yet, try looking it up via the Google langauge
        // code instead of Scratch's (e.g. for es-419 we look up es to get espanol)
        if (!langNameObj && languageNames.scratchToGoogleMap[this._viewerLanguageCode]) {
            const lookupCode = languageNames.scratchToGoogleMap[this._viewerLanguageCode];
            langNameObj = names.find(obj => obj.code === lookupCode);
        }

        let langName = this._viewerLanguageCode;
        if (langNameObj) {
            langName = langNameObj.name;
        }
        return langName;
    }

    /**
     * Get the viewer's language code.
     * @return {string} the language code.
     */
    getViewerLanguageCode () {
        const locale = formatMessage.setup().locale;
        const viewerLanguages = [locale].concat(navigator.languages);
        const languageKeys = Object.keys(languageNames.menuMap);
        // Return the first entry in viewerLanguages that matches
        // one of the available language keys.
        const languageCode = viewerLanguages.reduce((acc, lang) => {
            if (acc) {
                return acc;
            }
            if (languageKeys.indexOf(lang.toLowerCase()) > -1) {
                return lang;
            }
            return acc;
        }, '') || 'en';

        return languageCode.toLowerCase();
    }

    /**
     * Get a language code from a block argument. The arg can be a language code
     * or a language name, written in any language.
     * @param  {object} arg A block argument.
     * @return {string} A language code.
     */
    getLanguageCodeFromArg (arg) {
        const languageArg = Cast.toString(arg).toLowerCase();
        // Check if the arg matches a language code in the menu.
        if (languageNames.menuMap.hasOwnProperty(languageArg)) {
            return languageArg;
        }
        // Check for a dropped-in language name, and convert to a language code.
        if (languageNames.nameMap.hasOwnProperty(languageArg)) {
            return languageNames.nameMap[languageArg];
        }

        // There are some languages we launched in the language menu that Scratch did not
        // end up launching in. In order to keep projects that may have had that menu item
        // working, check for those language codes and let them through.
        // Examples: 'ab', 'hi'.
        if (languageNames.previouslySupported.indexOf(languageArg) !== -1) {
            return languageArg;
        }
        // Default to English.
        return 'en';
    }

    /**
     * Translates the text in the translate block to the language specified in the menu.
     * @param {object} args - the block arguments.
     * @return {Promise} - a promise that resolves after the response from the translate server.
     */
    getTranslate (args) {
        // If the text contains only digits 0-9 and nothing else, return it without
        // making a request.
        if (/^\d+$/.test(args.WORDS)) return Promise.resolve(args.WORDS);

        // Don't remake the request if we already have the value.
        if (this._lastTextTranslated === args.WORDS &&
            this._lastLangTranslated === args.LANGUAGE) {
            return this._translateResult;
        }

        const lang = this.getLanguageCodeFromArg(args.LANGUAGE);

        let urlBase = `${serverURL}translate?language=`;
        urlBase += lang;
        urlBase += '&text=';
        urlBase += encodeURIComponent(args.WORDS);

        const tempThis = this;
        const translatePromise = fetchWithTimeout(urlBase, {}, serverTimeoutMs)
            .then(response => response.text())
            .then(responseText => {
                const translated = JSON.parse(responseText).result;
                tempThis._translateResult = translated;
                // Cache what we just translated so we don't keep making the
                // same call over and over.
                tempThis._lastTextTranslated = args.WORDS;
                tempThis._lastLangTranslated = args.LANGUAGE;
                return translated;
            })
            .catch(err => {
                log.warn(`error fetching translate result! ${err}`);
                return '';
            });
        return translatePromise;
    }
}
module.exports = Scratch3TranslateBlocks;
